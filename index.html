<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta name="referrer" content="no-referrer" />
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>0402 å¯è§†åŒ–ç®¡ç†ç‰ˆ</title>
    <link rel="stylesheet" href="0402.css">
    <script src="https://sdk.jinrishici.com/v2/browser/jinrishici.js" charset="utf-8"></script>
</head>

<body>
    <div class="top">
        <img src="./img/1.png" alt="">
        <h1 class="tt">æ¬¢è¿æ‚¨çš„å…‰ä¸´ï¼è¯·å¼€å§‹äº«å—å§</h1>
    </div>

    <div class="b0402">
        <div class="c1" id="main-grid">
            <div class="c11">
                <div class="banner-img-container">
                    <img src="http://p.ananas.chaoxing.com/star3/origin/731917c94ae480eeb36847dd78b198c4.png">
                    <img src="http://p.ananas.chaoxing.com/star3/origin/ab00a63761f3c24c82f64aa303f97a43.png">
                    <img src="http://p.ananas.chaoxing.com/star3/origin/3ba2603b1a5005aeccfb43a370ec120b.png">
                    <img src="http://p.ananas.chaoxing.com/star3/origin/4b20f3296785d9b55a84f113a16e2e17.png">
                    <img src="http://p.ananas.chaoxing.com/star3/origin/d595de8ec4fff4264a9cd7537f862d93.png">
                </div>
            </div>
        </div>

        <div class="footer-fixed-area">
            <div class="yiyan-box">
                <span id="jinrishici-sentence">æ­£åœ¨åŠ è½½ä»Šæ—¥è¯—è¯....</span>
            </div>
            <div class="last">
                <div class="lt"><a href="README.md">æˆ‘æ˜¯è°ï¼Ÿ</a></div>
                <div class="lt"><a href="https://xgd1062.github.io/x/out.html">æ—§ä¸»é¡µ</a></div>
                <div class="lt"><a href="http://github.com/">GitHub</a></div>
            </div>
        </div>
    </div>

    <div class="admin-wrapper">
        <div class="admin-menu">
            <div class="menu-item" onclick="addNewCard()">â• æ–°å¢å¡ç‰‡</div>
            <div class="menu-item" onclick="openSyncModal()">â˜ï¸ GitHubåŒæ­¥</div>
            <div class="menu-item" onclick="exportJson()">ğŸ“‹ å¤åˆ¶JSON</div>
        </div>
        <div class="main-fab">âš™ï¸</div>
    </div>

    <div id="item-modal" class="modal">
        <div class="modal-content form-content">
            <div class="modal-header">
                <h2 id="form-title">ç¼–è¾‘å¡ç‰‡</h2>
                <span onclick="closeModal('item-modal')" class="close">&times;</span>
            </div>
            <div class="form-group">
                <label>æ ‡é¢˜</label>
                <input type="text" id="edit-title">
            </div>
            <div class="form-group">
                <label>é“¾æ¥ URL</label>
                <input type="text" id="edit-url">
            </div>
            <div class="form-group">
                <label>æè¿°</label>
                <input type="text" id="edit-desc">
            </div>
            <div class="form-group">
                <label>å›¾ç‰‡ URL</label>
                <input type="text" id="edit-img" oninput="previewImage(this.value)">
            </div>
            <div class="img-preview-box">
                <img id="img-preview" src="" alt="é¢„è§ˆ">
            </div>
            <div class="modal-footer">
                <button onclick="deleteCurrentItem()" class="btn-danger">åˆ é™¤</button>
                <button onclick="saveItemChange()" class="btn-primary">ä¿å­˜ä¿®æ”¹</button>
            </div>
        </div>
    </div>

    <div id="sync-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>åŒæ­¥åˆ° GitHub</h2>
                <span onclick="closeModal('sync-modal')" class="close">&times;</span>
            </div>
            <div class="form-group">
                <input type="password" id="gh-token" placeholder="GitHub Token">
                <input type="text" id="gh-repo" placeholder="ç”¨æˆ·å/ä»“åº“å (å¦‚: xgd1062/x)">
                <input type="text" id="gh-path" value="date.json" placeholder="æ–‡ä»¶è·¯å¾„">
            </div>
            <button onclick="syncToGithub()" id="sync-btn" class="btn-primary" style="width:100%">ç«‹å³è¦†ç›–äº‘ç«¯</button>
        </div>
    </div>

    <script>
        // å…¨å±€æ•°æ®å­˜å‚¨
        let globalData = [];
        let currentEditIndex = -1; // å½“å‰æ­£åœ¨ç¼–è¾‘çš„ç´¢å¼•

        const grid = document.getElementById('main-grid');

        // åˆå§‹åŒ–åŠ è½½
        fetch('date.json?v=' + Date.now()).then(r => r.json()).then(data => {
            globalData = data;
            renderGrid();
        }).catch(e => console.error("è¯·åœ¨æœåŠ¡å™¨ç¯å¢ƒä¸‹è¿è¡Œ"));

        // æ¸²æŸ“ç½‘æ ¼ (æ ¸å¿ƒé€»è¾‘)
        function renderGrid() {
            // ä¿ç•™è½®æ’­å›¾ï¼Œæ¸…ç©ºå…¶ä»–
            const banner = grid.querySelector('.c11');
            grid.innerHTML = '';
            grid.appendChild(banner);

            globalData.forEach((item, index) => {
                const card = document.createElement('div');
                card.className = 'c12';
                // å…³é”®ï¼šæ·»åŠ ç¼–è¾‘æŒ‰é’® (event.preventDefault é˜²æ­¢è·³è½¬)
                card.innerHTML = `
                    <div class="edit-btn-overlay" onclick="openEditModal(${index}, event)">âœ</div>
                    <a class="c122" href="${item.url}" target="_blank">
                        <img src="${item.img}" onerror="this.src='./img/1.png'">
                        <h1>${item.title}</h1>
                        <p>${item.desc}</p>
                    </a>
                `;
                grid.appendChild(card);
            });
        }

        // æ‰“å¼€ç¼–è¾‘å¼¹çª—
        function openEditModal(index, event) {
            if (event) {
                event.preventDefault(); // é˜»æ­¢é“¾æ¥è·³è½¬
                event.stopPropagation();
            }
            currentEditIndex = index;
            const item = globalData[index];

            document.getElementById('form-title').innerText = "ç¼–è¾‘å¡ç‰‡";
            document.getElementById('edit-title').value = item.title;
            document.getElementById('edit-url').value = item.url;
            document.getElementById('edit-desc').value = item.desc;
            document.getElementById('edit-img').value = item.img;
            document.getElementById('img-preview').src = item.img;

            document.getElementById('item-modal').style.display = 'flex';
        }

        // æ–°å¢å¡ç‰‡
        function addNewCard() {
            currentEditIndex = -1; // -1 ä»£è¡¨æ–°å¢æ¨¡å¼
            document.getElementById('form-title').innerText = "æ–°å¢å¡ç‰‡";
            // æ¸…ç©ºè¡¨å•
            ['edit-title', 'edit-url', 'edit-desc', 'edit-img'].forEach(id => document.getElementById(id).value = '');
            document.getElementById('img-preview').src = '';
            document.getElementById('item-modal').style.display = 'flex';
        }

        // å›¾ç‰‡å®æ—¶é¢„è§ˆ
        function previewImage(url) {
            document.getElementById('img-preview').src = url;
        }

        // ä¿å­˜ä¿®æ”¹ (ä»…æœ¬åœ°å†…å­˜)
        function saveItemChange() {
            const newItem = {
                title: document.getElementById('edit-title').value,
                url: document.getElementById('edit-url').value,
                desc: document.getElementById('edit-desc').value,
                img: document.getElementById('edit-img').value
            };

            if (currentEditIndex === -1) {
                globalData.push(newItem); // æ–°å¢
            } else {
                globalData[currentEditIndex] = newItem; // ä¿®æ”¹
            }

            renderGrid();
            closeModal('item-modal');
        }

        // åˆ é™¤å¡ç‰‡
        function deleteCurrentItem() {
            if (currentEditIndex === -1) return;
            if (confirm("ç¡®å®šè¦åˆ é™¤è¿™ä¸ªå¡ç‰‡å—ï¼Ÿ")) {
                globalData.splice(currentEditIndex, 1);
                renderGrid();
                closeModal('item-modal');
            }
        }

        // å¯¼å‡º/å¤åˆ¶ JSON
        function exportJson() {
            navigator.clipboard.writeText(JSON.stringify(globalData, null, 4));
            alert("å®Œæ•´ JSON å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼");
        }

        // --- ä»¥ä¸‹æ˜¯äº‘ç«¯åŒæ­¥é€»è¾‘ ---
        function openSyncModal() { document.getElementById('sync-modal').style.display = 'flex'; }
        function closeModal(id) { document.getElementById(id).style.display = 'none'; }

        async function syncToGithub() {
            const btn = document.getElementById('sync-btn');
            const token = document.getElementById('gh-token').value.trim();
            const repo = document.getElementById('gh-repo').value.trim();
            const path = document.getElementById('gh-path').value.trim();
            const branch = "main"; // ç¡®ä¿ä½ çš„ä»“åº“é»˜è®¤åˆ†æ”¯æ˜¯ main

            if (!token || !repo) return alert("è¯·å¡«å†™å®Œæ•´ GitHub ä¿¡æ¯");

            btn.innerText = "â³ æ­£åœ¨åŒæ­¥...";
            btn.disabled = true;

            try {
                // 1. è·å–æ–‡ä»¶çš„ SHA æ ¡éªŒç 
                // è¿™é‡Œçš„ Header å¿…é¡»ç²¾ç®€ï¼Œé˜²æ­¢è§¦å‘ CORS æ‹¦æˆª
                const getRes = await fetch(`https://api.github.com/repos/${repo}/contents/${path}?ref=${branch}`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });

                if (!getRes.ok) {
                    const errorInfo = await getRes.json();
                    throw new Error(`è·å–æ–‡ä»¶å¤±è´¥: ${errorInfo.message}`);
                }

                const fileData = await getRes.json();
                const fileSha = fileData.sha;

                // 2. æäº¤æ›´æ–°
                // æ³¨æ„ï¼šPUT è¯·æ±‚çš„ headers ä¹Ÿè¦ä¸¥æ ¼æ§åˆ¶
                const putRes = await fetch(`https://api.github.com/repos/${repo}/contents/${path}`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Accept': 'application/vnd.github.v3+json',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        message: "CMS Update: " + new Date().toLocaleString(),
                        content: btoa(unescape(encodeURIComponent(JSON.stringify(globalData, null, 4)))),
                        sha: fileSha,
                        branch: branch
                    })
                });

                if (putRes.ok) {
                    alert("âœ… åŒæ­¥æˆåŠŸï¼äº‘ç«¯æ•°æ®å·²æ›´æ–°ã€‚");
                    closeModal('sync-modal');
                } else {
                    const errorInfo = await putRes.json();
                    throw new Error(`æ›´æ–°å¤±è´¥: ${errorInfo.message}`);
                }

            } catch (e) {
                console.error("åŒæ­¥è¯¦æƒ…æŠ¥é”™:", e);
                alert("âŒ åŒæ­¥è¿‡ç¨‹å‡ºé”™: " + e.message);
            } finally {
                btn.innerText = "ç«‹å³è¦†ç›–äº‘ç«¯";
                btn.disabled = false;
            }
        }
    </script>
</body>

</html>