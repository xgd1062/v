<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta name="referrer" content="no-referrer" />
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¯¼èˆªç®¡ç†ç³»ç»Ÿ V4.5 - æ€§èƒ½ä¼˜åŒ–ç‰ˆ</title>
    <link rel="stylesheet" href="0402.css">
    <script src="https://sdk.jinrishici.com/v2/browser/jinrishici.js" charset="utf-8" defer></script>
    <script src="https://lib.baomitu.com/Sortable/1.15.0/Sortable.min.js" defer></script>
</head>

<body>
    <div class="top">
        <img src="./img/1.png" alt="" onerror="this.style.opacity='0'">
        <h1 class="tt">æ¬¢è¿æ‚¨çš„å…‰ä¸´ï¼è¯·å¼€å§‹äº«å—å§</h1>
    </div>

    <div class="b0402">
        <div class="c1" id="main-grid">
            <div class="c11">
                <div class="banner-img-container">
                    <img src="http://p.ananas.chaoxing.com/star3/origin/731917c94ae480eeb36847dd78b198c4.png" loading="lazy">
                    <img src="http://p.ananas.chaoxing.com/star3/origin/ab00a63761f3c24c82f64aa303f97a43.png" loading="lazy">
                    <img src="http://p.ananas.chaoxing.com/star3/origin/3ba2603b1a5005aeccfb43a370ec120b.png" loading="lazy">
                    <img src="http://p.ananas.chaoxing.com/star3/origin/4b20f3296785d9b55a84f113a16e2e17.png" loading="lazy">
                    <img src="http://p.ananas.chaoxing.com/star3/origin/d595de8ec4fff4264a9cd7537f862d93.png" loading="lazy">
                </div>
            </div>
        </div>

        <div class="footer-fixed-area">
            <div class="yiyan-box">
                <span id="jinrishici-sentence">æ­£åœ¨åŠ è½½ä»Šæ—¥è¯—è¯....</span>
            </div>
            <div class="last">
                <div class="lt"><a href="README.md">æˆ‘æ˜¯è°ï¼Ÿ</a></div>
                <div class="lt"><a href="https://xgd1062.github.io/x/out.html">æ—§ä¸»é¡µ</a></div>
                <div class="lt"><a href="http://github.com/">GitHub</a></div>
            </div>
        </div>
    </div>

    <div class="admin-wrapper">
        <div class="admin-menu">
            <div class="menu-item" onclick="addNewCard()">â• æ–°å¢å¡ç‰‡</div>
            <div class="menu-item" onclick="toggleDragMode()" id="drag-mode-btn">ğŸ–ï¸ å¼€å¯æ‹–æ‹½æ’åº</div>
            <div class="menu-item" onclick="openSyncModal()">â˜ï¸ GitHubåŒæ­¥</div>
        </div>
        <div class="main-fab">âš™ï¸</div>
    </div>

    <div id="item-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="form-title">ç¼–è¾‘å¡ç‰‡</h2><span onclick="closeModal('item-modal')" class="close">&times;</span>
            </div>
            <div class="form-group"><label>æ ‡é¢˜</label><input type="text" id="edit-title"></div>
            <div class="form-group"><label>é“¾æ¥</label><input type="text" id="edit-url"></div>
            <div class="form-group"><label>æè¿°</label><input type="text" id="edit-desc"></div>
            <div class="form-group"><label>å›¾ç‰‡</label><input type="text" id="edit-img" oninput="previewImage(this.value)"></div>
            <div class="img-preview-box"><img id="img-preview" src=""></div>
            <div class="modal-footer">
                <button onclick="deleteCurrentItem()" class="btn-danger">åˆ é™¤</button>
                <button onclick="saveItemChange()" class="btn-primary">ä¿å­˜</button>
            </div>
        </div>
    </div>

    <div id="sync-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>åŒæ­¥åˆ° GitHub</h2><span onclick="closeModal('sync-modal')" class="close">&times;</span>
            </div>
            <div class="form-group"><input type="password" id="gh-token" placeholder="GitHub Token"></div>
            <div class="form-group"><input type="text" id="gh-repo" placeholder="ç”¨æˆ·å/ä»“åº“å (å¦‚: xgd1062/v)"></div>
            <button onclick="syncToGithub()" id="sync-btn" class="btn-primary" style="width:100%">è¦†ç›–äº‘ç«¯ data.json</button>
        </div>
    </div>

    <script>
        let globalData = [];
        let currentEditIndex = -1;
        let isDragMode = false;
        let sortableInstance = null;
        const grid = document.getElementById('main-grid');

        // é¢„è®¾æ¸å˜èƒŒæ™¯
        const gradients = [
            'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
            'linear-gradient(135deg, #18b7f6 0%, #4facfe 100%)',
            'linear-gradient(135deg, #43e97b 0%, #38f9d7 100%)',
            'linear-gradient(135deg, #fa709a 0%, #fee140 100%)',
            'linear-gradient(135deg, #6a11cb 0%, #2575fc 100%)'
        ];

        // --- æ ¸å¿ƒä¼˜åŒ–ï¼šå…ˆæ˜¾ç¤ºç¼“å­˜ï¼Œåå¼‚æ­¥è¯·æ±‚ ---
        const cached = localStorage.getItem('nav_data_cache');
        if (cached) {
            globalData = JSON.parse(cached);
            renderGrid();
        }

        async function initData() {
            try {
                const r = await fetch('data.json?v=' + Date.now());
                const data = await r.json();
                // ä»…åœ¨æ•°æ®æœ‰å˜åŠ¨æ—¶é‡æ–°æ¸²æŸ“
                if (JSON.stringify(data) !== JSON.stringify(globalData)) {
                    globalData = data;
                    localStorage.setItem('nav_data_cache', JSON.stringify(data));
                    renderGrid();
                }
            } catch (e) {
                console.error("åŠ è½½æœ€æ–°æ•°æ®å¤±è´¥ï¼Œå·²ä½¿ç”¨æœ¬åœ°ç¼“å­˜");
            }
        }
        initData();

        function renderGrid() {
            const banner = grid.querySelector('.c11');
            const fragment = document.createDocumentFragment(); // ä½¿ç”¨ç‰‡æ®µä¼˜åŒ–æ€§èƒ½
            fragment.appendChild(banner);

            globalData.forEach((item, index) => {
                const card = document.createElement('div');
                card.className = 'c12' + (isDragMode ? ' draggable-active' : '');
                card.dataset.index = index;

                const grad = gradients[index % gradients.length];
                const hasImg = item.img && item.img.trim() !== "";

                card.innerHTML = `
                    <div class="edit-btn-overlay" onclick="openEditModal(${index},event)">âœ</div>
                    <a class="c122" href="${isDragMode ? 'javascript:void(0)' : item.url}" 
                       ${isDragMode ? '' : 'target="_blank"'} 
                       style="background: ${grad}">
                        ${hasImg ? `<img src="${item.img}" loading="lazy" onerror="this.style.display='none'">` : ''}
                        <h1>${item.title}</h1>
                        <p>${item.desc || ''}</p>
                    </a>
                `;
                fragment.appendChild(card);
            });

            grid.innerHTML = '';
            grid.appendChild(fragment);

            if (isDragMode) initSortable();
        }

        // --- ç®¡ç†é€»è¾‘ (æ–°å¢/ä¿å­˜/åˆ é™¤/æ’åº) ---
        function initSortable() {
            if (!window.Sortable) return;
            sortableInstance = Sortable.create(grid, {
                animation: 150, draggable: ".c12", ghostClass: "sortable-ghost",
                onEnd: function () {
                    const newArr = Array.from(grid.querySelectorAll('.c12')).map(el => globalData[el.dataset.index]);
                    globalData = newArr;
                    localStorage.setItem('nav_data_cache', JSON.stringify(globalData));
                    renderGrid();
                }
            });
        }

        function toggleDragMode() {
            isDragMode = !isDragMode;
            document.getElementById('drag-mode-btn').innerText = isDragMode ? "âœ… å®Œæˆæ’åº" : "ğŸ–ï¸ å¼€å¯æ‹–æ‹½æ’åº";
            renderGrid();
        }

        function openEditModal(index, e) {
            e.preventDefault(); e.stopPropagation();
            currentEditIndex = index;
            const item = globalData[index];
            document.getElementById('edit-title').value = item.title;
            document.getElementById('edit-url').value = item.url;
            document.getElementById('edit-desc').value = item.desc || "";
            document.getElementById('edit-img').value = item.img || "";
            document.getElementById('img-preview').src = item.img || "";
            document.getElementById('item-modal').style.display = 'flex';
        }

        function addNewCard() {
            currentEditIndex = -1;
            document.querySelectorAll('#item-modal input').forEach(i => i.value = '');
            document.getElementById('img-preview').src = '';
            document.getElementById('item-modal').style.display = 'flex';
        }

        function saveItemChange() {
            const obj = {
                title: document.getElementById('edit-title').value,
                url: document.getElementById('edit-url').value,
                desc: document.getElementById('edit-desc').value,
                img: document.getElementById('edit-img').value
            };
            if (currentEditIndex === -1) globalData.push(obj);
            else globalData[currentEditIndex] = obj;
            localStorage.setItem('nav_data_cache', JSON.stringify(globalData));
            renderGrid(); closeModal('item-modal');
        }

        function deleteCurrentItem() { 
            if (confirm("ç¡®å®šè¦åˆ é™¤è¿™ä¸ªå¡ç‰‡å—ï¼Ÿ")) { 
                globalData.splice(currentEditIndex, 1); 
                localStorage.setItem('nav_data_cache', JSON.stringify(globalData));
                renderGrid(); closeModal('item-modal'); 
            } 
        }

        function previewImage(u) { document.getElementById('img-preview').src = u; }
        function closeModal(id) { document.getElementById(id).style.display = 'none'; }
        function openSyncModal() { document.getElementById('sync-modal').style.display = 'flex'; }

        async function syncToGithub() {
            const btn = document.getElementById('sync-btn');
            const token = document.getElementById('gh-token').value.trim();
            const repo = document.getElementById('gh-repo').value.trim() || "xgd1062/v";
            btn.innerText = "â³ åŒæ­¥ä¸­..."; btn.disabled = true;
            try {
                const getRes = await fetch(`https://api.github.com/repos/${repo}/contents/data.json?ref=main`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const fileData = await getRes.json();
                const putRes = await fetch(`https://api.github.com/repos/${repo}/contents/data.json`, {
                    method: 'PUT',
                    headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        message: "Update data.json via web UI", 
                        content: btoa(unescape(encodeURIComponent(JSON.stringify(globalData, null, 4)))), 
                        sha: fileData.sha, 
                        branch: "main" 
                    })
                });
                if (putRes.ok) alert("âœ… åŒæ­¥åˆ° GitHub æˆåŠŸï¼"); 
                else throw new Error("åŒæ­¥å¤±è´¥");
            } catch (e) { alert("âŒ é”™è¯¯ï¼š" + e.message); }
            finally { btn.innerText = "è¦†ç›–äº‘ç«¯ data.json"; btn.disabled = false; }
        }
    </script>
</body>

</html>