<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta name="referrer" content="no-referrer" />
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¯¼èˆªç®¡ç†ç³»ç»Ÿ V4.5 (SortableJS ç‰ˆ)</title>
    <link rel="stylesheet" href="0402.css">
    <script src="https://sdk.jinrishici.com/v2/browser/jinrishici.js" charset="utf-8"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
</head>
<body>
    <div class="top">
        <img src="./img/1.png" alt="">
        <h1 class="tt">æ¬¢è¿æ‚¨çš„å…‰ä¸´ï¼è¯·å¼€å§‹äº«å—å§</h1>
    </div>

    <div class="b0402">
        <div class="c1" id="main-grid">
            <div class="c11">
                <div class="banner-img-container">
                    <img src="http://p.ananas.chaoxing.com/star3/origin/731917c94ae480eeb36847dd78b198c4.png">
                    <img src="http://p.ananas.chaoxing.com/star3/origin/ab00a63761f3c24c82f64aa303f97a43.png">
                    <img src="http://p.ananas.chaoxing.com/star3/origin/3ba2603b1a5005aeccfb43a370ec120b.png">
                    <img src="http://p.ananas.chaoxing.com/star3/origin/4b20f3296785d9b55a84f113a16e2e17.png">
                    <img src="http://p.ananas.chaoxing.com/star3/origin/d595de8ec4fff4264a9cd7537f862d93.png">
                </div>
            </div>
        </div>

        <div class="footer-fixed-area">
            <div class="yiyan-box">
                <span id="jinrishici-sentence">æ­£åœ¨åŠ è½½ä»Šæ—¥è¯—è¯....</span>
            </div>
            <div class="last">
                <div class="lt"><a href="README.md">æˆ‘æ˜¯è°ï¼Ÿ</a></div>
                <div class="lt"><a href="https://xgd1062.github.io/x/out.html">æ—§ä¸»é¡µ</a></div>
                <div class="lt"><a href="http://github.com/">GitHub</a></div>
            </div>
        </div>
    </div>

    <div class="admin-wrapper">
        <div class="admin-menu">
            <div class="menu-item" onclick="addNewCard()">â• æ–°å¢å¡ç‰‡</div>
            <div class="menu-item" onclick="toggleDragMode()" id="drag-mode-btn">ğŸ–ï¸ å¼€å¯æ‹–æ‹½æ’åº</div>
            <div class="menu-item" onclick="openSyncModal()">â˜ï¸ GitHubåŒæ­¥</div>
        </div>
        <div class="main-fab">âš™ï¸</div>
    </div>

    <div id="item-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header"><h2 id="form-title">ç¼–è¾‘å¡ç‰‡</h2><span onclick="closeModal('item-modal')" class="close">&times;</span></div>
            <div class="form-group"><label>æ ‡é¢˜</label><input type="text" id="edit-title"></div>
            <div class="form-group"><label>é“¾æ¥</label><input type="text" id="edit-url"></div>
            <div class="form-group"><label>æè¿°</label><input type="text" id="edit-desc"></div>
            <div class="form-group"><label>å›¾ç‰‡</label><input type="text" id="edit-img" oninput="previewImage(this.value)"></div>
            <div class="img-preview-box"><img id="img-preview" src=""></div>
            <div class="modal-footer">
                <button onclick="deleteCurrentItem()" class="btn-danger">åˆ é™¤</button>
                <button onclick="saveItemChange()" class="btn-primary">ä¿å­˜</button>
            </div>
        </div>
    </div>

    <div id="sync-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header"><h2>åŒæ­¥åˆ° GitHub</h2><span onclick="closeModal('sync-modal')" class="close">&times;</span></div>
            <div class="form-group"><input type="password" id="gh-token" placeholder="GitHub Token"></div>
            <div class="form-group"><input type="text" id="gh-repo" placeholder="ç”¨æˆ·å/ä»“åº“å (å¦‚: xgd1062/v)"></div>
            <button onclick="syncToGithub()" id="sync-btn" class="btn-primary" style="width:100%">è¦†ç›–äº‘ç«¯ data.json</button>
        </div>
    </div>

    <script>
        let globalData = [];
        let currentEditIndex = -1;
        let isDragMode = false;
        let sortableInstance = null;
        const grid = document.getElementById('main-grid');

        // åŠ è½½æ•°æ®
        fetch('data.json?v=' + Date.now()).then(r => r.json()).then(data => {
            globalData = data;
            renderGrid();
        }).catch(() => alert("æ•°æ®åŠ è½½å¤±è´¥"));

        function renderGrid() {
            const banner = grid.querySelector('.c11');
            grid.innerHTML = '';
            grid.appendChild(banner);

            globalData.forEach((item, index) => {
                const card = document.createElement('div');
                card.className = 'c12' + (isDragMode ? ' draggable-active' : '');
                card.dataset.index = index; // ç»‘å®šç´¢å¼•
                card.innerHTML = `
                    <div class="edit-btn-overlay" onclick="openEditModal(${index},event)">âœ</div>
                    <a class="c122" href="${isDragMode ? 'javascript:void(0)' : item.url}" ${isDragMode ? '' : 'target="_blank"'}>
                        <img src="${item.img}" onerror="this.src='./img/1.png'">
                        <h1>${item.title}</h1>
                        <p>${item.desc}</p>
                    </a>
                `;
                grid.appendChild(card);
            });

            // å¦‚æœå¤„äºæ‹–æ‹½æ¨¡å¼ï¼Œå¯ç”¨ Sortable
            if (isDragMode) {
                initSortable();
            } else if (sortableInstance) {
                sortableInstance.destroy();
                sortableInstance = null;
            }
        }

        function initSortable() {
            sortableInstance = Sortable.create(grid, {
                animation: 150,
                draggable: ".c12", // åªæœ‰ c12 å¡ç‰‡å¯ä»¥æ‹–åŠ¨
                ghostClass: "sortable-ghost", // å ä½ç¬¦æ ·å¼
                onEnd: function (evt) {
                    // è·å–æ–°çš„é¡ºåº
                    const newArr = [];
                    const items = grid.querySelectorAll('.c12');
                    items.forEach(el => {
                        newArr.push(globalData[el.dataset.index]);
                    });
                    globalData = newArr;
                    renderGrid(); // é‡æ–°æ¸²æŸ“åˆ·æ–° dataset-index
                }
            });
        }

        function toggleDragMode() {
            isDragMode = !isDragMode;
            document.getElementById('drag-mode-btn').innerText = isDragMode ? "âœ… å®Œæˆæ’åº" : "ğŸ–ï¸ å¼€å¯æ‹–æ‹½æ’åº";
            renderGrid();
        }

        // --- ç¼–è¾‘é€»è¾‘ ---
        function openEditModal(index, e) {
            e.preventDefault(); e.stopPropagation();
            if (isDragMode) return;
            currentEditIndex = index;
            const item = globalData[index];
            document.getElementById('edit-title').value = item.title;
            document.getElementById('edit-url').value = item.url;
            document.getElementById('edit-desc').value = item.desc;
            document.getElementById('edit-img').value = item.img;
            document.getElementById('img-preview').src = item.img;
            document.getElementById('item-modal').style.display = 'flex';
        }

        function addNewCard() {
            currentEditIndex = -1;
            document.querySelectorAll('#item-modal input').forEach(i => i.value = '');
            document.getElementById('item-modal').style.display = 'flex';
        }

        function saveItemChange() {
            const obj = { title: document.getElementById('edit-title').value, url: document.getElementById('edit-url').value, desc: document.getElementById('edit-desc').value, img: document.getElementById('edit-img').value };
            if (currentEditIndex === -1) globalData.push(obj); else globalData[currentEditIndex] = obj;
            renderGrid(); closeModal('item-modal');
        }

        function deleteCurrentItem() { if(confirm("åˆ é™¤è¯¥å¡ç‰‡ï¼Ÿ")) { globalData.splice(currentEditIndex, 1); renderGrid(); closeModal('item-modal'); } }
        function previewImage(u) { document.getElementById('img-preview').src = u; }
        function closeModal(id) { document.getElementById(id).style.display = 'none'; }
        function openSyncModal() { document.getElementById('sync-modal').style.display = 'flex'; }

        // --- GitHub åŒæ­¥ä»£ç  (ä¿æŒ Bearer è®¤è¯) ---
        async function syncToGithub() {
            const btn = document.getElementById('sync-btn');
            const token = document.getElementById('gh-token').value.trim();
            const repo = document.getElementById('gh-repo').value.trim();
            btn.innerText = "â³ åŒæ­¥ä¸­..."; btn.disabled = true;
            try {
                const getRes = await fetch(`https://api.github.com/repos/${repo}/contents/data.json?ref=main`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const fileData = await getRes.json();
                const putRes = await fetch(`https://api.github.com/repos/${repo}/contents/data.json`, {
                    method: 'PUT',
                    headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message: "Update", content: btoa(unescape(encodeURIComponent(JSON.stringify(globalData, null, 4)))), sha: fileData.sha, branch: "main" })
                });
                if (putRes.ok) alert("âœ… åŒæ­¥æˆåŠŸï¼"); else throw new Error("ä¸Šä¼ å¤±è´¥");
            } catch (e) { alert("âŒ é”™è¯¯ï¼š" + e.message); }
            finally { btn.innerText = "è¦†ç›–äº‘ç«¯ data.json"; btn.disabled = false; }
        }
    </script>
</body>
</html>