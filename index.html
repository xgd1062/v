<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta name="referrer" content="no-referrer" />
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æé€Ÿå¯¼èˆªç®¡ç†ç³»ç»Ÿ V5.0</title>
    <link rel="stylesheet" href="0402.css">
    <link rel="preconnect" href="https://lf26-cdn-tos.bytecdntp.com">
    <script src="https://lf26-cdn-tos.bytecdntp.com/cdn/expire-1-M/sortablejs/1.14.0/Sortable.min.js" defer></script>
</head>
<body>
    <div class="top">
        <h1 class="tt">æ¬¢è¿å…‰ä¸´ï¼å¼€å§‹ç®¡ç†æ‚¨çš„å¯¼èˆª</h1>
    </div>

    <div class="b0402">
        <div class="c1" id="main-grid">
            <div class="c11">
                <div class="banner-img-container">
                    <img src="https://p.ananas.chaoxing.com/star3/origin/731917c94ae480eeb36847dd78b198c4.png">
                    <img src="https://p.ananas.chaoxing.com/star3/origin/ab00a63761f3c24c82f64aa303f97a43.png">
                </div>
            </div>
        </div>

        <div class="footer-fixed-area">
            <div class="yiyan-box">
                <span id="jinrishici-sentence">ç”Ÿæ´»åŸæœ¬æ²‰é—·ï¼Œä½†è·‘èµ·æ¥å°±æœ‰é£ã€‚</span>
            </div>
            <div class="last">
                <a href="#">æˆ‘çš„ä¸»é¡µ</a>
                <a href="https://github.com/xgd1062/v">GitHub ä»“åº“</a>
            </div>
        </div>
    </div>

    <div class="admin-wrapper">
        <div class="admin-menu">
            <div class="menu-item" onclick="addNewCard()">â• æ–°å¢å¡ç‰‡</div>
            <div class="menu-item" onclick="toggleDragMode()" id="drag-mode-btn">ğŸ–ï¸ å¼€å¯æ‹–æ‹½æ’åº</div>
            <div class="menu-item" onclick="openSyncModal()">â˜ï¸ GitHubåŒæ­¥</div>
        </div>
        <div class="main-fab">âš™ï¸</div>
    </div>

    <div id="item-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header"><h2>å¡ç‰‡ç®¡ç†</h2><span onclick="closeModal('item-modal')" class="close">&times;</span></div>
            <div class="form-group"><label>æ ‡é¢˜</label><input type="text" id="edit-title"></div>
            <div class="form-group"><label>é“¾æ¥</label><input type="text" id="edit-url"></div>
            <div class="form-group"><label>æè¿°</label><input type="text" id="edit-desc"></div>
            <div class="form-group"><label>å›¾ç‰‡</label><input type="text" id="edit-img" oninput="document.getElementById('img-preview').src=this.value"></div>
            <div class="img-preview-box"><img id="img-preview" src=""></div>
            <div class="modal-footer">
                <button onclick="deleteCurrentItem()" class="btn-danger">åˆ é™¤</button>
                <button onclick="saveItemChange()" class="btn-primary">ä¿å­˜ä¿®æ”¹</button>
            </div>
        </div>
    </div>

    <div id="sync-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header"><h2>åŒæ­¥äº‘ç«¯æ•°æ®</h2><span onclick="closeModal('sync-modal')" class="close">&times;</span></div>
            <div class="form-group"><label>GitHub Token</label><input type="password" id="gh-token"></div>
            <div class="form-group"><label>ä»“åº“å</label><input type="text" id="gh-repo" value="xgd1062/v"></div>
            <div class="form-group"><label>æ–‡ä»¶å</label><input type="text" id="gh-path" value="data.json"></div>
            <button onclick="syncToGithub()" id="sync-btn" class="btn-primary" style="width:100%">ç¡®è®¤å¹¶åŒæ­¥</button>
        </div>
    </div>

    <script>
        let globalData = [];
        let currentEditIndex = -1;
        let isDragMode = false;
        let sortableInstance = null;
        const grid = document.getElementById('main-grid');

        // é¡µé¢åˆå§‹åŒ–é€»è¾‘
        window.addEventListener('DOMContentLoaded', () => {
            // 1. ä¼˜å…ˆæ¸²æŸ“æœ¬åœ°æ•°æ®
            fetch('data.json?v=' + Date.now()).then(r => r.json()).then(data => {
                globalData = data;
                renderGrid();
            }).catch(() => console.log("ç­‰å¾…æ•°æ®é…ç½®"));

            // 2. å»¶è¿ŸåŠ è½½ä»Šæ—¥è¯—è¯ï¼Œé˜²æ­¢é˜»å¡
            setTimeout(loadPoetryAsync, 500);
        });

        // å¼‚æ­¥åŠ è½½ä»Šæ—¥è¯—è¯
        function loadPoetryAsync() {
            const script = document.createElement('script');
            script.src = "https://sdk.jinrishici.com/v2/browser/jinrishici.js";
            script.onload = () => {
                if(window.jinrishici) {
                    window.jinrishici.load(res => {
                        document.getElementById('jinrishici-sentence').innerText = res.data.content;
                    });
                }
            };
            document.body.appendChild(script);
        }

        function renderGrid() {
            const banner = grid.querySelector('.c11');
            grid.innerHTML = ''; grid.appendChild(banner);
            globalData.forEach((item, index) => {
                const card = document.createElement('div');
                card.className = 'c12' + (isDragMode ? ' draggable-active' : '');
                card.dataset.index = index;
                card.innerHTML = `
                    <div class="edit-btn-overlay" onclick="openEditModal(${index},event)">âœ</div>
                    <a class="c122" href="${isDragMode ? 'javascript:void(0)' : item.url}" target="_blank">
                        <img src="${item.img}" loading="lazy" onerror="this.src='https://via.placeholder.com/150'">
                        <h1>${item.title}</h1><p>${item.desc}</p>
                    </a>`;
                grid.appendChild(card);
            });
            if (isDragMode) initSortable();
        }

        function initSortable() {
            if(sortableInstance) sortableInstance.destroy();
            sortableInstance = Sortable.create(grid, {
                animation: 150, draggable: ".c12",
                onEnd: () => {
                    const newArr = [];
                    grid.querySelectorAll('.c12').forEach(el => newArr.push(globalData[el.dataset.index]));
                    globalData = newArr;
                    renderGrid();
                }
            });
        }

        function toggleDragMode() {
            isDragMode = !isDragMode;
            document.getElementById('drag-mode-btn').innerText = isDragMode ? "âœ… å®Œæˆæ’åº" : "ğŸ–ï¸ å¼€å¯æ‹–æ‹½æ’åº";
            renderGrid();
        }

        function openEditModal(index, e) {
            e.stopPropagation(); if (isDragMode) return;
            currentEditIndex = index;
            const item = globalData[index];
            document.getElementById('edit-title').value = item.title;
            document.getElementById('edit-url').value = item.url;
            document.getElementById('edit-desc').value = item.desc;
            document.getElementById('edit-img').value = item.img;
            document.getElementById('img-preview').src = item.img;
            document.getElementById('item-modal').style.display = 'flex';
        }

        function addNewCard() {
            currentEditIndex = -1;
            document.querySelectorAll('#item-modal input').forEach(i => i.value = '');
            document.getElementById('item-modal').style.display = 'flex';
        }

        function saveItemChange() {
            const obj = { title: document.getElementById('edit-title').value, url: document.getElementById('edit-url').value, desc: document.getElementById('edit-desc').value, img: document.getElementById('edit-img').value };
            if (currentEditIndex === -1) globalData.push(obj); else globalData[currentEditIndex] = obj;
            renderGrid(); closeModal('item-modal');
        }

        function deleteCurrentItem() { if(confirm("åˆ é™¤ï¼Ÿ")) { globalData.splice(currentEditIndex, 1); renderGrid(); closeModal('item-modal'); } }
        function closeModal(id) { document.getElementById(id).style.display = 'none'; }
        function openSyncModal() { document.getElementById('sync-modal').style.display = 'flex'; }

        async function syncToGithub() {
            const btn = document.getElementById('sync-btn');
            const token = document.getElementById('gh-token').value.trim();
            const repo = document.getElementById('gh-repo').value.trim();
            const path = document.getElementById('gh-path').value.trim();
            if (!token) return alert("è¯·è¾“å…¥ Token");
            btn.innerText = "â³ æ­£åœ¨è¿æ¥..."; btn.disabled = true;
            try {
                const getRes = await fetch(`https://api.github.com/repos/${repo}/contents/${path}`);
                const fileData = await getRes.json();
                const putRes = await fetch(`https://api.github.com/repos/${repo}/contents/${path}`, {
                    method: 'PUT',
                    headers: { 'Authorization': `token ${token}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        message: "Update",
                        content: btoa(unescape(encodeURIComponent(JSON.stringify(globalData, null, 4)))),
                        sha: fileData.sha
                    })
                });
                if (putRes.ok) alert("âœ… åŒæ­¥æˆåŠŸï¼"); else throw new Error("åŒæ­¥å¤±è´¥");
            } catch (e) { alert("é”™è¯¯: " + e.message); }
            finally { btn.innerText = "ç¡®è®¤å¹¶åŒæ­¥"; btn.disabled = false; }
        }
    </script>
</body>
</html>